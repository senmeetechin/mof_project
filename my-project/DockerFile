# Base image
FROM python:3.9-slim-buster AS base

# Set working directory
WORKDIR /app

# Copy the requirements files and create the virtual environments
COPY env/requirements.txt .
COPY env/base.yml .
COPY env/mof_env.yml .
COPY env/tf_env.yml .

# Install Conda and create the virtual environments
RUN apt-get update && apt-get install -y curl \
    && curl -sSLO https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    && bash Miniconda3-latest-Linux-x86_64.sh -bfp /usr/local \
    && export PATH=/opt/conda/bin:$PATH \
    # && conda env create -f base.yml \
    && conda env create -f mof_env.yml \
    && conda env create -f tf_env.yml \
    # && echo "source activate base" > ~/.bashrc \
    && export PATH=/opt/conda/envs/base/bin:$PATH \
    && conda clean -afy

# Install Python packages
RUN pip install --no-cache-dir -r requirements.txt

# Build frontend assets
FROM node:16.14.0-alpine3.14 AS build
WORKDIR /app
COPY src/package.json src/package-lock.json ./
RUN npm ci
COPY src/ ./
RUN npm run build

# Production image
FROM base AS production

# Copy the backend code and frontend assets
COPY backend/ .

# Copy the built frontend assets
COPY --from=build /app/build/ ./static/

# Start the Flask app
CMD ["python", "app.py"]
